# StatsService 真实数据实现说明

## 概述

StatsService已经从模拟数据升级为真实数据实现，现在所有的统计数据都直接从数据库中查询，提供准确、实时的区块链统计信息。

## 架构设计

### 1. 分层架构
```
HomeHandler (控制器层)
    ↓
StatsService (服务层)
    ↓
StatsRepository (数据访问层)
    ↓
Database (MySQL)
```

### 2. 核心组件

#### StatsRepository
- **位置**: `server/internal/repository/stats_repository.go`
- **职责**: 负责所有统计数据的数据库查询
- **特点**: 使用原生SQL和GORM混合查询，优化性能

#### StatsService
- **位置**: `server/internal/services/stats_service.go`
- **职责**: 业务逻辑处理，调用repository获取数据
- **特点**: 纯业务逻辑，无数据访问代码

## 实现的功能

### 1. 基础统计
- **总区块数**: 从`blocks`表统计指定链的区块总数
- **总交易数**: 从`transaction`表统计指定链的交易总数

### 2. 活跃地址统计
- **活跃地址数**: 统计指定时间范围内有交易活动的唯一地址数
- **实现方式**: 使用UNION查询合并发送方和接收方地址
- **SQL优化**: 使用DISTINCT去重，提高查询效率

### 3. 网络算力计算
- **ETH算力**: `难度 / 12秒 * 2^32`
- **BTC算力**: `难度 * 2^32 / 600秒`
- **数据来源**: 最近100个区块的平均难度

### 4. 交易量统计
- **日交易量**: 统计24小时内的交易金额总和
- **数据来源**: `transaction`表的`amount`字段
- **精度处理**: 使用DECIMAL类型避免浮点数精度问题

### 5. Gas价格统计
- **平均Gas价格**: 统计最近1000个ETH交易的Gas价格平均值
- **链限制**: 仅对ETH链计算，BTC返回0
- **数据来源**: `transaction`表的`gas_price`字段

### 6. 出块时间统计
- **平均出块时间**: 计算最近100个区块的时间间隔平均值
- **算法**: 相邻区块时间差的总和除以区块数
- **数据来源**: `blocks`表的`timestamp`字段

### 7. 难度统计
- **当前难度**: 获取最新区块的难度值
- **格式支持**: 支持普通数字和科学计数法格式
- **数据来源**: `blocks`表的`difficulty`字段

## 数据库查询优化

### 1. 索引使用
- **链类型索引**: `chain`字段建立索引，提高查询速度
- **时间索引**: `ctime`字段建立索引，优化时间范围查询
- **高度索引**: `height`字段建立索引，优化区块查询

### 2. 查询策略
- **分页查询**: 大量数据使用LIMIT限制，避免内存溢出
- **字段选择**: 只查询需要的字段，减少数据传输
- **条件优化**: 使用合适的WHERE条件，提高查询效率

### 3. 性能优化
- **批量查询**: 一次性获取多个区块数据，减少数据库往返
- **缓存友好**: 查询结果适合缓存，提高响应速度
- **连接池**: 使用GORM连接池，优化数据库连接管理

## 错误处理

### 1. 数据缺失处理
- **空值检查**: 检查数据库字段是否为NULL或空字符串
- **默认值**: 提供合理的默认值，避免程序崩溃
- **日志记录**: 记录查询错误，便于问题排查

### 2. 异常情况处理
- **数据库连接**: 处理数据库连接失败的情况
- **查询超时**: 设置合理的查询超时时间
- **数据格式**: 处理数据格式不一致的情况

## 配置说明

### 1. 数据库配置
```yaml
database:
  driver: mysql
  host: localhost
  port: 3306
  username: your_username
  password: your_password
  dbname: your_database
  max_open_conns: 100
  max_idle_conns: 10
  conn_max_lifetime: 3600s
```

### 2. 查询参数配置
- **区块数量限制**: 最近100个区块
- **交易数量限制**: 最近1000个交易
- **时间范围**: 24小时活跃地址统计
- **缓存时间**: 统计数据缓存5分钟

## 使用示例

### 1. 获取ETH统计数据
```go
stats, err := statsService.GetNetworkHashrate(ctx, "eth")
if err != nil {
    log.Printf("获取ETH网络算力失败: %v", err)
    return
}
log.Printf("ETH网络算力: %d H/s", stats)
```

### 2. 获取BTC统计数据
```go
volume, err := statsService.GetDailyVolume(ctx, "btc")
if err != nil {
    log.Printf("获取BTC日交易量失败: %v", err)
    return
}
log.Printf("BTC日交易量: %.2f", volume)
```

## 监控和维护

### 1. 性能监控
- **查询时间**: 监控各个统计查询的执行时间
- **内存使用**: 监控大量数据查询的内存占用
- **数据库负载**: 监控数据库连接数和查询频率

### 2. 数据质量
- **数据完整性**: 检查统计数据是否完整
- **数据准确性**: 验证统计数据是否准确
- **数据一致性**: 确保不同时间点的数据一致

### 3. 故障排查
- **日志分析**: 分析错误日志，定位问题
- **性能分析**: 使用数据库慢查询日志分析性能问题
- **数据验证**: 对比不同数据源，验证数据正确性

## 未来扩展

### 1. 功能扩展
- **历史统计**: 支持自定义时间范围的统计数据
- **图表数据**: 提供图表所需的聚合数据
- **实时更新**: 支持WebSocket实时推送统计数据

### 2. 性能优化
- **数据缓存**: 实现Redis缓存，提高查询速度
- **异步计算**: 使用后台任务预计算统计数据
- **数据分区**: 按时间分区，提高查询效率

### 3. 监控增强
- **指标收集**: 收集更多性能指标
- **告警机制**: 实现异常情况告警
- **报表生成**: 自动生成统计报表

## 总结

StatsService的真实数据实现提供了：

1. **准确性**: 所有数据都来自数据库，确保数据真实可靠
2. **实时性**: 数据实时查询，反映最新的区块链状态
3. **性能**: 优化的查询策略，确保快速响应
4. **可扩展性**: 模块化设计，便于功能扩展和维护
5. **可靠性**: 完善的错误处理，确保系统稳定运行

通过这个实现，区块链浏览器现在可以提供准确、实时的统计数据，为用户提供更好的区块链数据浏览体验。

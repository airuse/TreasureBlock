# 数据清理调度器配置说明

## 概述

数据清理调度器用于自动清理ETH和BTC链的旧数据，包括 `transactions`、`transaction_receipts`、`contract_parse_results` 和 `blocks` 表的数据。

## 配置参数

### ETH链配置
- **最大保留区块数**: 50,000
- **清理阈值**: 50,000（当超过此数量时开始清理）
- **批量删除大小**: 1,000
- **清理间隔**: 60分钟

### BTC链配置
- **最大保留区块数**: 5,000
- **清理阈值**: 5,000（当超过此数量时开始清理）
- **批量删除大小**: 500
- **清理间隔**: 120分钟

## 安全机制

### 受保护地址
系统会自动保护与 `user_addresses` 表相关的数据：
- 如果交易、收据或合约解析结果中的地址与用户地址表中的地址匹配，则不会被删除
- 这确保了用户相关数据的完整性

### 批量删除
- 使用批量删除避免长时间锁表
- 每次删除后短暂延迟，减少对数据库性能的影响
- 使用事务确保数据一致性

## 配置管理

数据清理调度器通过配置文件进行管理，无需API接口。配置在 `config.yaml` 文件中：

```yaml
# 数据清理配置
data_cleanup:
  eth:
    max_blocks: 50000        # ETH最大保留区块数
    cleanup_threshold: 50000 # ETH清理阈值
    batch_size: 1000         # ETH批量删除大小
    interval: 60             # ETH清理间隔（分钟）
  btc:
    max_blocks: 5000         # BTC最大保留区块数
    cleanup_threshold: 5000  # BTC清理阈值
    batch_size: 500          # BTC批量删除大小
    interval: 120            # BTC清理间隔（分钟）
```

## 清理逻辑

1. **检查清理条件**: 当区块数量超过清理阈值时开始清理
2. **获取清理基准高度**: 找到第 `MaxBlocks` 个区块的高度作为清理基准
3. **获取受保护地址**: 从 `user_addresses` 表获取所有受保护地址
4. **执行清理**: 按顺序清理各表数据，排除与受保护地址相关的记录

## 性能优化

- 使用索引优化查询性能
- 批量删除减少数据库负载
- 异步执行避免阻塞主线程
- 事务保证数据一致性

## 监控建议

- 观察清理执行日志
- 监控数据库性能影响
- 根据实际情况调整配置参数
- 定期检查清理效果

## 配置调整

如需调整清理参数，请修改 `config.yaml` 文件中的 `data_cleanup` 部分，然后重启服务即可生效。
